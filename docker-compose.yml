version: "3.8"

services:
  drachtio:
    image: drachtio/drachtio-server:latest
    container_name: drachtio-server
    ports:
      - "9022:9022"
      - "5060:5060/udp"
      - "5060:5060/tcp"
    volumes:
      - ./drachtio/drachtio.conf.xml:/etc/drachtio.conf.xml
    command: drachtio --daemon=false --sofia-loglevel=3
    networks:
      - bridge-network
    restart: unless-stopped

  rtpengine:
    image: drachtio/rtpengine:latest
    container_name: rtpengine
    network_mode: host
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_NICE
    volumes:
      - /proc:/proc
    command: >
      rtpengine
      --interface=127.0.0.1!${PUBLIC_IP:-127.0.0.1}
      --listen-ng=127.0.0.1:2223
      --port-min=10000
      --port-max=20000
      --log-level=6
      --log-stderr
      --foreground
      --dtls-passive
    restart: unless-stopped

  signaling-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: signaling-server
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DRACHTIO_HOST=drachtio
      - DRACHTIO_PORT=9022
      - DRACHTIO_SECRET=cymru
      - RTPENGINE_HOST=host.docker.internal
      - RTPENGINE_PORT=2223
      - SIP_TRUNK_HOST=${SIP_TRUNK_HOST}
      - SIP_TRUNK_PORT=${SIP_TRUNK_PORT:-5060}
      - SIP_USERNAME=${SIP_USERNAME}
      - SIP_PASSWORD=${SIP_PASSWORD}
      - SIP_DOMAIN=${SIP_DOMAIN}
      - PUBLIC_IP=${PUBLIC_IP:-127.0.0.1}
    volumes:
      - ./server:/app
      - /app/node_modules
    depends_on:
      - drachtio
      - rtpengine
    networks:
      - bridge-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  web-client:
    image: nginx:alpine
    container_name: web-client
    ports:
      - "8080:80"
    volumes:
      - ./client:/usr/share/nginx/html:ro
    networks:
      - bridge-network
    restart: unless-stopped

networks:
  bridge-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16